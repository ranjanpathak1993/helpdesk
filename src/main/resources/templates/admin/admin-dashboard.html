<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard | Zenex</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    font-family:Poppins, sans-serif;
    background:#0b1220;
    color:white;
}

/* SIDEBAR */
.sidebar{
    position:fixed;top:0;left:0;
    width:240px;height:100vh;
    background:#060c18;padding:20px;
}
.sidebar h2{color:#00eaff;text-align:center;margin-bottom:30px}
.sidebar a{
    display:block;padding:12px;margin:8px 0;
    color:#cfd8ff;text-decoration:none;border-radius:8px;
}
.sidebar a:hover,.sidebar a.active{
    background:#00eaff;color:#001423;font-weight:600;
}

/* MAIN */
.main{margin-left:260px;padding:30px}

/* CHAT BOX */
#adminChat{
    position:fixed;right:20px;bottom:20px;
    width:320px;background:#121a2f;
    border-radius:14px;overflow:hidden;
    box-shadow:0 0 15px rgba(0,0,0,.6);
}
#chatArea{
    height:220px;overflow-y:auto;
    padding:8px;font-size:13px;
}
.msg-admin{
    color:#00eaff;margin:6px 0;
    background:#00eaff22;padding:6px;
    border-radius:6px;display:inline-block;
}
.msg-user{
    color:#ffea76;margin:6px 0;
    background:#ffea7622;padding:6px;
    border-radius:6px;display:inline-block;
}
</style>
</head>

<body>

<div class="sidebar">
    <h2>âš™ Zenex Admin</h2>
    <a href="/admin/dashboard" class="active">ðŸ“Š Dashboard</a>
    <a href="/admin/tickets">ðŸŽ« Tickets</a>
    <a href="/admin/reports">ðŸ“‘ Reports</a>
    <a href="/admin/analytics">ðŸ“ˆ Analytics</a>
    <a href="/admin/chat-reports">ðŸ’¬ Chat Reports</a>
    <a href="/logout">ðŸšª Logout</a>
</div>

<div class="main">
    <h1 style="color:#00eaff">Dashboard</h1>

    <!-- CHAT BOX -->
    <div id="adminChat">
        <div style="background:#00eaff;color:#001423;padding:10px;font-weight:700">
            ðŸ’¬ Live User Chat
        </div>

        <div style="padding:8px">
            <input id="empId" placeholder="Employee ID"
            style="width:100%;padding:6px;border-radius:6px;border:none">
        </div>

        <div id="chatArea"></div>

        <div style="display:flex;padding:8px;gap:6px">
            <input id="adminMsg" placeholder="Reply..."
            style="flex:1;padding:6px;border-radius:6px;border:none">
            <button onclick="sendAdmin()" style="
                background:#00eaff;border:none;padding:6px 10px;
                border-radius:6px;font-weight:600">Send</button>
        </div>
    </div>
</div>


<!-- ************* FINAL REAL-TIME CHAT JS *************** -->

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>

let stomp = null;
let currentEmp = null;

/* CONNECT ADMIN TO WEBSOCKET */
function connectAdmin() {
    if (stomp) return;

    const sock = new SockJS('/chat-support');
    stomp = Stomp.over(sock);

    stomp.connect({}, () => {
        console.log("Admin WebSocket Connected");
    });
}

/* EMPLOYEE ID CHANGE = load old + start live chat */
document.getElementById("empId").addEventListener("change", () => {
    currentEmp = empId.value.trim();
    if (!currentEmp) return;

    // load existing chat via HTTP
    loadHistory();

    // then connect WebSocket
    connectAdmin();

    // subscribe to user's real-time topic
    subscribeToUser(currentEmp);
});

/* SUBSCRIBE TO REAL-TIME MESSAGES */
function subscribeToUser(empId) {

    stomp.subscribe("/topic/chat/" + empId, (msg) => {
        const m = JSON.parse(msg.body);

        chatArea.innerHTML += `
            <div class="${m.sender === 'ADMIN' ? 'msg-admin' : 'msg-user'}">
                <b>${m.sender}:</b> ${m.message}
            </div>
        `;

        chatArea.scrollTop = chatArea.scrollHeight;
    });

    // new user alerts
    stomp.subscribe("/topic/admin-alert", (msg) => {
        console.log("New User:", msg.body);
    });
}

/* LOAD HISTORY (HTTP AS IS) */
function loadHistory() {
    fetch(`/chat/history/${currentEmp}`)
        .then(r => r.json())
        .then(list => {
            chatArea.innerHTML = "";
            list.forEach(m => {
                chatArea.innerHTML += `
                    <div class="${m.sender === 'ADMIN' ? 'msg-admin' : 'msg-user'}">
                        <b>${m.sender}:</b> ${m.message}
                    </div>`;
            });
            chatArea.scrollTop = chatArea.scrollHeight;
        });
}

/* SEND MESSAGE USING WEBSOCKET */
function sendAdmin() {
    if (!currentEmp || !adminMsg.value.trim()) return;

    connectAdmin(); // ensure WS is live

    stomp.send("/app/chat.reply", {}, JSON.stringify({
        employeeId: currentEmp,
        sender: "ADMIN",
        message: adminMsg.value
    }));

    adminMsg.value = ""; // clear box
}

</script>

</body>
</html>
