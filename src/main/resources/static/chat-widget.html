<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>User Chat</title>

<style>
#chatIcon {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #007bff;
  color: white;
  padding: 14px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 22px;
}

#chatBox {
  position: fixed;
  bottom: 80px;
  right: 20px;
  width: 320px;
  background: #ffffff;
  border-radius: 10px;
  border: 1px solid #ccc;
  display: none;
  overflow: hidden;
}

#header {
  background: #007bff;
  color: white;
  padding: 10px;
  font-weight: bold;
}

#messages {
  height: 240px;
  overflow-y: auto;
  padding: 10px;
  background: #f5f5f5;
}

.msg-user {
  background: #d1e7ff;
  padding: 8px;
  border-radius: 8px;
  margin: 5px 0;
  width: fit-content;
  max-width: 85%;
}

.msg-admin {
  background: #ffe4d1;
  padding: 8px;
  border-radius: 8px;
  margin: 5px 0;
  width: fit-content;
  max-width: 85%;
  margin-left: auto;
}

input, button {
  padding: 8px;
  margin: 5px;
}
</style>

</head>

<body>

<div id="chatIcon">ðŸ’¬</div>

<div id="chatBox">
  <div id="header">Chat Support</div>

  <input id="empId" placeholder="Employee ID" style="width:95%">
  <div id="messages"></div>

  <input id="msg" placeholder="Type message..." style="width:70%">
  <button onclick="sendChat()">Send</button>
</div>

<script>

function sendChat(){
    const emp = document.getElementById("empId").value;
    const msg = document.getElementById("msg").value;

    if(!emp || !msg) return;

    fetch("/chat/send", {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: `employeeId=${emp}&message=${encodeURIComponent(msg)}&sender=USER`
    }).then(()=>{
        document.getElementById("msg").value = "";
        loadChat(emp);
    });
}

function loadChat(emp){
    fetch("/chat/history/" + emp)
    .then(r => r.json())
    .then(data => {
        let html = "";
        data.forEach(m => {
            if(m.sender === "ADMIN"){
                html += `<div class="msg-admin">${m.message}</div>`;
            } else {
                html += `<div class="msg-user">${m.message}</div>`;
            }
        });

        document.getElementById("messages").innerHTML = html;
        const box = document.getElementById("messages");
        box.scrollTop = box.scrollHeight;
    })
}

document.getElementById("chatIcon").onclick = () => {
    document.getElementById("chatBox").style.display = "block";
};

// Auto refresh chat every 2 seconds
setInterval(()=>{
    const emp = document.getElementById("empId").value;
    if(emp) loadChat(emp);
}, 2000);

</script>

</body>
</html>
